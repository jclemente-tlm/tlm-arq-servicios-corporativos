apiGateway = softwareSystem "API Gateway" {
    description "Punto de entrada para todas las solicitudes a los microservicios."
    tags "API Gateway" "001 - Fase 1"

    yarp = application "YARP API Gateway" {
        technology "YARP"
        description "Proxy inverso que enruta solicitudes a los microservicios corporativos."
        tags "API Gateway" "001 - Fase 1"

        authentication = component "Authentication Middleware" {
            technology "Middleware"
            description "Middleware que autentica usuarios y genera tokens JWT."
            tags "Middleware" "001 - Fase 1"

            admin -> this "Gestiona configuraciones de servicios" "HTTPS" "001 - Fase 1"
            appPeru -> this "Hace llamadas API" "HTTPS" "001 - Fase 1"
            appEcuador -> this "Hace llamadas API" "HTTPS" "001 - Fase 1"
            appColombia -> this "Hace llamadas API" "HTTPS"
            appMexico -> this "Hace llamadas API" "HTTPS"
        }

        tenantResolution = component "Tenant Resolution Middleware" {
            technology "Middleware"
            description "Middleware que resuelve el inquilino (tenant) de la solicitud."
            tags "Middleware" "001 - Fase 1"

            authentication -> this "Llama a" "" "001 - Fase 1"
        }

        rateLimit = component "Rate Limiting Middleware" {
            technology "Middleware"
            description "Middleware que limita la cantidad de solicitudes por usuario."
            tags "Middleware" "001 - Fase 1"

            tenantResolution -> this "Llama a" "" "001 - Fase 1"
        }

        // Nuevos componentes de resiliencia
        circuitBreaker = component "Circuit Breaker" {
            technology "Polly, Middleware"
            description "Implementa patrón Circuit Breaker para prevenir cascadas de fallos."
            tags "Middleware, Resilience" "001 - Fase 1"

            rateLimit -> this "Llama a" "" "001 - Fase 1"
        }

        retryPolicy = component "Retry Policy Handler" {
            technology "Polly, Middleware"
            description "Maneja políticas de reintento con backoff exponencial."
            tags "Middleware, Resilience" "001 - Fase 1"

            circuitBreaker -> this "Llama a" "" "001 - Fase 1"
        }

        timeout = component "Timeout Handler" {
            technology "Middleware"
            description "Gestiona timeouts para evitar requests colgantes."
            tags "Middleware, Resilience" "001 - Fase 1"

            retryPolicy -> this "Llama a" "" "001 - Fase 1"
        }

        authorization = component "Authorization Middleware" {
            technology "Middleware"
            description "Middleware que valida los tokens JWT y verifica permisos."
            tags "Middleware" "001 - Fase 1"

            timeout -> this "Llama a" "" "001 - Fase 1"
        }

        // Componente de observabilidad
        healthCheck = component "Health Check Aggregator" {
            technology "ASP.NET Core Health Checks"
            description "Agrega y expone el estado de salud de todos los servicios downstream."
            tags "Observability" "001 - Fase 1"
        }
    }
}